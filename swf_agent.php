<?php	/*	Plugin Name: swf agent	Plugin URI: http://wordpress.org/#swf_agent	Description: user agent dependant theme switcher	Author: Julien Barbay	Version: 1	Author URI: http://blog.martian-arts.org/	*/	//************************************** ADMIN SIDE		function swf_install()	{		global $wpdb;				$table_name = $wpdb->prefix."swf_agents";		if($wpdb->get_var("SHOW TABLES LIKE '$table_name'") != $table_name)		{			$sql = "CREATE TABLE ".$table_name." (				  id mediumint(9) NOT NULL AUTO_INCREMENT,				  useragent text NOT NULL,				  theme text NOT NULL,				  UNIQUE KEY id (id)				);";						require_once(ABSPATH."wp-admin/includes/upgrade.php");			dbDelta($sql);						$default_theme_uri = get_bloginfo("template_directory");			$default_theme = substr($default_theme_uri, strrpos($default_theme_uri, "/") + 1);						$wpdb->insert($table_name, array("useragent" => "Googlebot",	"theme" => $default_theme));			$wpdb->insert($table_name, array("useragent" => "iPhone",		"theme" => $default_theme));			$wpdb->insert($table_name, array("useragent" => "iPod",			"theme" => $default_theme));		}	}		function swf_admin() { add_action("admin_menu", "swf_menu"); }	function swf_menu()	{ add_submenu_page("plugins.php", __("SWF Agents"), __("SWF Agents"), "manage_options", "swf-agents-config", "swf_panel"); }		function swf_panel()	{		global $wpdb;		$table_name = $wpdb->prefix."swf_agents";				if (isset($_POST["action"]) && in_array($_POST["action"], array("0", "1", "2")))		{			switch($_POST["action"])			{				case "0":					$wpdb->insert($table_name, array("useragent" => $_POST["swf_useragent"], "theme" => $_POST["swf_theme"]));					break;								case "1":					$wpdb->query("UPDATE $table_name SET useragent='".$_POST['swf_useragent']."', theme='".$_POST['swf_theme']."' WHERE id=".$_POST["id"]);					break;								case "2":					$wpdb->query("DELETE FROM $table_name WHERE id=".$_POST["id"]);					break;			}		}				$data = $wpdb->get_results("SELECT * FROM $table_name", OBJECT);		$data = array_reverse($data);				$themes = get_themes();		$conversion = array();			foreach($themes as $theme) { $conversion[$theme['Template']] = $theme['Name']; }?>				<style>			#swf_plugin { width:99%; }						#swf_title { margin: 24px 0px 18px 0px; }			#swf_title h2			{				float: left;				margin: -2px 10px 0px 0px;			}						#swf_title a { margin-top: -2px; }						#swf_add			{				display: none;				margin: 0px 0px 14px 0px;				padding: 7px 7px 7px 17px;				border: 1px solid #E3E3E3;				-moz-border-radius: 4px;				font-size:11px;			}						#swf_add label { vertical-align: baseline; }			#swf_add select { width:250px; }						#swf_rules { width:100%; }			#swf_rules tbody tr { height: 35px; }			#swf_rules tbody tr td { vertical-align: middle; }			#swf_rules .buttons { width: 70px; }						#swf_infos			{				border-top: 1px solid #E3E3E3;				margin-top:25px;				padding:20px;			}						#swf_infos h3 { margin-top:0px; }		</style>		<script type="text/javascript">			function swf_add()			{				document.getElementById("swf_action").value = 0;				document.getElementById("swf_id").value = -1;				document.getElementById("submit_button").value = "<?php _e("Save"); ?>";								document.getElementById("swf_add").swf_useragent.value = "";				document.getElementById("swf_theme").options[0].selected = true;								document.getElementById("swf_add").style.display = "block";								return false;			}						function swf_edit(id)			{				document.getElementById("swf_action").value = 1;				document.getElementById("swf_id").value = id;				document.getElementById("submit_button").value = "<?php _e("Update"); ?>";								document.getElementById("swf_add").swf_useragent.value = document.getElementById("swf_rule_useragent_" + id).innerHTML;								for (var i = 0; i < document.getElementById("swf_theme").options.length; i++)				{					if (document.getElementById("swf_theme")[i].innerHTML == document.getElementById("swf_rule_theme_" + id).innerHTML)					{ document.getElementById("swf_theme")[i].selected = true; }				}								document.getElementById("swf_add").style.display = "block";												return false;			}						function swf_delete(id)			{				document.getElementById("swf_action").value = 2;				document.getElementById("swf_id").value = id;								document.getElementById("swf_add").submit();								return false;			}		</script>		<div id="swf_plugin">		<div id="swf_title">			<h2><?php _e("SWF Agents"); ?></h2>			<a href="#" class="button" onclick="swf_add()"><?php _e("Add new rule") ?></a>		</div>				<form id="swf_add" action="" method="post">				<input id="swf_action" type="hidden" name="action" value="0" />			<input id="swf_id" type="hidden" name="id" value="-1" />						<label for="swf_useragent"><?php _e("The user agent :") ?></label>			<input type="text" name="swf_useragent" value="" />					<label for="swf_theme"><?php _e("uses this theme :") ?></label>			<select id="swf_theme" name="swf_theme">				<?php foreach($themes as $theme) : ?>								<option value="<?php _e($theme['Template']); ?>"><?php _e($theme['Name']); ?></option>								<?php endforeach; ?>			</select>					<input id="submit_button" type="submit" class="button" value="<?php _e("Save"); ?>" />				</form>				<table id="swf_rules" class="widefat fixed">			<thead>				<tr>					<th style="" class="manage-column" id="swf_agent_col" scope="col">User Agent</th>					<th style="" class="manage-column" id="swf_theme_col" scope="col">Chosen Theme</th>					<th style="" class="manage-column buttons" id="swf_edit_col" scope="col"></th>					<th style="" class="manage-column buttons" id="swf_del_col" scope="col"></th>				</tr>			</thead>			<tfoot>				<tr>					<th style="" class="manage-column" id="swf_agent_col" scope="col">User Agent</th>					<th style="" class="manage-column" id="swf_theme_col" scope="col">Chosen Theme</th>					<th style="" class="manage-column buttons" id="swf_edit_col" scope="col"></th>					<th style="" class="manage-column buttons" id="swf_del_col" scope="col"></th>				</tr>			</tfoot>			<tbody>				<?php foreach($data as $item) : ?>								<tr id="swf_rule_<?php echo $item->id; ?>">						<td id="swf_rule_useragent_<?php echo $item->id; ?>"><?php echo $item->useragent; ?></td>						<td id="swf_rule_theme_<?php echo $item->id; ?>"><?php echo $conversion[$item->theme]; ?></td>						<td class="buttons"><a href="#" class="button" onclick="swf_edit(<?php echo $item->id; ?>);"><?php _e("edit"); ?></a></td>						<td class="buttons"><a href="#" class="button" onclick="swf_delete(<?php echo $item->id; ?>);"><?php _e("delete"); ?></a></td>					</tr>								<?php endforeach; ?>			</tbody>		</table>				<div id="swf_infos">			<h3><?php _e("Infos"); ?></h3>			<p>				<?php _e("The plugin is very simple. Every time the theme attempts to get its directory reference, swf_agents catches the call, and gives the directory of the theme you defined in the table. It can be very usefull to redirect bots or crawlers to a strict SEO compliant theme or redirect phones to a personal mobile theme. You can set as many user agents as you want, pointing to any installed themes. You can put part of a user agent or fully detailed string for a more precise match. A list of user agents can be found at "); ?><a href="http://www.user-agents.org/"><?php _e("user-agents.org"); ?></a>.			</p>		</div>				</div><?php			}		//************************************** CLIENT SIDE		function swf_client()	{		if (is_admin()) { return; }		add_action('setup_theme', 'swf_filters');	}		function swf_filters()	{		add_filter('template_directory', 'swf_override_directory');		add_filter('stylesheet_directory', 'swf_override_directory');		add_filter('template_directory_uri', 'swf_override_directory_uri');		add_filter('stylesheet_directory_uri', 'swf_override_directory_uri');	}		function swf_override_directory($data) { return get_theme_root()."/".swf_get_theme_for_user_agent()."/"; }	function swf_override_directory_uri($data) { return get_theme_root_uri()."/".swf_get_theme_for_user_agent(); }		function swf_get_theme_for_user_agent()	{		global $wpdb;		$table_name = $wpdb->prefix."swf_agents";				$container = $_SERVER['HTTP_USER_AGENT'];		$data = $wpdb->get_results("SELECT * FROM $table_name", OBJECT);				$reference = array();			foreach($data as $rule) { $reference[$rule->useragent] = $rule->theme; }				foreach ($reference as $key => $value) { if (eregi($key, $container)) { return $value; } }				$current = get_current_theme();		$themes = get_themes();			foreach($themes as $theme) { if ($current == $theme['Name']) { return $theme['Template']; } }				return "twentyten";	}		//ADMIN HOOK	register_activation_hook(__FILE__, "swf_install");	add_action("init", "swf_admin");		//CLIENT HOOK	add_action("plugins_loaded", "swf_client");?>